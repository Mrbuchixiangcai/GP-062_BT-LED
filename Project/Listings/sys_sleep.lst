C51 COMPILER V9.00   SYS_SLEEP                                                             12/06/2018 14:18:36 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE SYS_SLEEP
OBJECT MODULE PLACED IN ..\Object\sys_sleep.obj
COMPILER INVOKED BY: D:\ProgramFiles\Keil_v5\C51\BIN\C51.EXE ..\Hardware\SystemSleep\sys_sleep.c OPTIMIZE(8,SPEED) BROWS
                    -E INCDIR(..\User;..\Hardware;..\Hardware\BT;..\Hardware\KEY;..\Hardware\LED;..\Hardware\SystemSleep) DEBUG OBJECTEXTEND 
                    -PRINT(.\Listings\sys_sleep.lst) OBJECT(..\Object\sys_sleep.obj)

line level    source

   1          /*************************************************************/
   2          /*头文件Header File*******************************************/
   3          /*************************************************************/
   4          #include "app_main.h"
   5          
   6          /*************************************************************/
   7          /*宏定义Macro Definition**************************************/
   8          /*************************************************************/
   9          
  10          /*************************************************************/
  11          /*类型定义Byte Definition**************************************/
  12          /*************************************************************/
  13          
  14          /*************************************************************/
  15          /*标志位定义Flags Definition***********************************/
  16          /*************************************************************/
  17          
  18          /*************************************************************/
  19          /*变量定义Variable Definition**********************************/
  20          /*************************************************************/
  21          
  22          /*************************************************************/
  23          /*数组定义Array Definition************************************/
  24          /*************************************************************/
  25          
  26          /*************************************************************/
  27          /*函数声明Function Declaration*********************************/
  28          /*************************************************************/
  29          
  30          /*************************************************************/
  31          /*函数定义Function Definition**********************************/
  32          /*************************************************************/
  33          /*******************************************************************************
  34          * 函数原型：
  35          * 输入参数：
  36          * 输出参数：
  37          * 函数功能：
  38          * 返回值说明：
  39          * 创建日期：
  40          * 创建人：
  41          * 修改日期
  42          * 修改人：
  43          * 第N次修改：
  44          * 修改原因：
  45          * 备注：
  46          *******************************************************************************/
  47          void DataBackups(void)
  48          {
  49   1              Alarm1PowerOFF();
  50   1              Display_Off();
  51   1              gRTC_Hour_bk   = gRTC_Hour;
  52   1              gRTC_Minute_bk = gRTC_Minute;
  53   1              gRTC_Day_bk    = gRTC_Day;
C51 COMPILER V9.00   SYS_SLEEP                                                             12/06/2018 14:18:36 PAGE 2   

  54   1              gRTC_Month_bk  = gRTC_Month;
  55   1              gRTC_Year_bk   = gRTC_Year;
  56   1              gRTC_Zone_bk   = gRTC_Zone;
  57   1      }
  58          
  59          /*******************************************************************************
  60          * 函数原型：
  61          * 输入参数：
  62          * 输出参数：
  63          * 函数功能：把端口设置为省电模式
  64          * 返回值说明：
  65          * 创建日期：
  66          * 创建人：
  67          * 修改日期
  68          * 修改人：
  69          * 第N次修改：
  70          * 修改原因：
  71          * 备注：
  72          *******************************************************************************/
  73          void SetGPIO_Sleep(void)
  74          {
  75   1              P0 = 0x00;
  76   1              P1 = 0x00;
  77   1              P2 = 0x00;
  78   1              P3 = 0x00;
  79   1              P4 = 0x00;
  80   1              P5 = 0x00;
  81   1              P6 = 0x00;
  82   1      }
  83          
  84          /*******************************************************************************
  85          * 函数原型：
  86          * 输入参数：
  87          * 输出参数：
  88          * 函数功能：关闭定时器Timer0,把端口设置为睡眠状态
  89          * 返回值说明：
  90          * 创建日期：
  91          * 创建人：
  92          * 修改日期
  93          * 修改人：
  94          * 第N次修改：
  95          * 修改原因：
  96          * 备注：
  97          *******************************************************************************/
  98          void InitT0_Sleep(void)
  99          {
 100   1              LVRCR = 0x01;  // 进 IDLE/STOP 不打开低压复位，低压复位关闭 0x01
 101   1              IE2 &= ~0x12;  // 关闭定时器 T0和T3 中断
 102   1              T0CR &= ~0x80; // 关闭 T0 定时器
 103   1              T3CR &= ~0x80; // 关闭 T0 定时器
 104   1              SetGPIO_Sleep();  // 配置省电模式 IO 口
 105   1      }
 106          
 107          /*******************************************************************************
 108          * 函数原型：
 109          * 输入参数：
 110          * 输出参数：
 111          * 函数功能：
 112          * 返回值说明：
 113          * 创建日期：
 114          * 创建人：
 115          * 修改日期
C51 COMPILER V9.00   SYS_SLEEP                                                             12/06/2018 14:18:36 PAGE 3   

 116          * 修改人：
 117          * 第N次修改：
 118          * 修改原因：
 119          * 备注：
 120          *******************************************************************************/
 121          void CLKToCRYL(void)
 122          {
 123   1              SCCR = 0x02;      //外部副时钟做主时钟
 124   1              OSCCR |= 0x04;    //关闭内部RC，关闭外部副时钟振荡器
 125   1      }
 126          
 127          /*******************************************************************************
 128          * 函数原型：
 129          * 输入参数：
 130          * 输出参数：
 131          * 函数功能：进入STOP/IDLE模式之后必须立即写入三个以上的 NOP指令
 132          * 返回值说明：
 133          * 创建日期：
 134          * 创建人：
 135          * 修改日期
 136          * 修改人：
 137          * 第N次修改：
 138          * 修改原因：
 139          * 备注：
 140          *******************************************************************************/
 141          void IN_IDLE_Delay(void)
 142          {
 143   1              uint8_t idata tp0;//延时专用临时变量
 144   1              for(tp0=0;tp0<=10;tp0++)
 145   1                      ;
 146   1      }
 147          
 148          /*******************************************************************************
 149          * 函数原型：
 150          * 输入参数：
 151          * 输出参数：
 152          * 函数功能：系统初始化，用在掉电再上电之后
 153          * 返回值说明：
 154          * 创建日期：
 155          * 创建人：
 156          * 修改日期
 157          * 修改人：
 158          * 第N次修改：
 159          * 修改原因：
 160          * 备注：
 161          *******************************************************************************/
 162          void System_init(void)
 163          {
 164   1              cli();                  // disable INT. during peripheral setting
 165   1              port_init();            // initialize ports
 166   1              clock_init();           // initialize operation clock
 167   1              BUZ_init();             // initialize Buzzer
 168   1              LCD_init();             // initialize LCD
 169   1              Timer0_init();          // initialize Timer0
 170   1              Timer3_init();          // initialize Timer3
 171   1              sei();                  // enable INT.
 172   1      }
 173          
 174          /*******************************************************************************
 175          * 函数原型：
 176          * 输入参数：
 177          * 输出参数：
C51 COMPILER V9.00   SYS_SLEEP                                                             12/06/2018 14:18:36 PAGE 4   

 178          * 函数功能：
 179          * 返回值说明：
 180          * 创建日期：
 181          * 创建人：
 182          * 修改日期
 183          * 修改人：
 184          * 第N次修改：
 185          * 修改原因：
 186          * 备注：
 187          *******************************************************************************/
 188          uint8_t  cntCheckDC_IDLE; //检测到低电压计数，然后到了100ms之后还是低就关闭显示
 189          void CheckDC(void)
 190          {
 191   1              uint8_t i;
 192   1              uint8_t data cntIDLE;
 193   1              if(!CHECK_DC_DEC())//检测到电压降低，然后进入这里
 194   1              {
 195   2                      cntCheckDC_IDLE++;
 196   2                      if(cntCheckDC_IDLE<=10)//100ms
 197   2                      {
 198   3                              return;//延时100ms
 199   3                      }
 200   2                      cntCheckDC_IDLE=12;
 201   2                      DataBackups();
 202   2                      Flag_PowerOn=0;
 203   2                      InitT0_Sleep();
 204   2                      CLKToCRYL();
 205   2                      while(1)
 206   2                      {
 207   3                              PCON=0x01;  //进入IDLE省点模式
 208   3                              IN_IDLE_Delay();//进入IDLE专用的3个NOP延时
 209   3                              cntIDLE=0;
 210   3                              while((!CHECK_DC_DEC()))
 211   3                              {
 212   4                                      for(i=0;i<16;i++)
 213   4                                                      ;
 214   4                                      if(++cntIDLE>=4)//延时确定是否上电
 215   4                                              break;
 216   4                              }
 217   3                              if(cntIDLE>=4)
 218   3                                      break;
 219   3                              System_init();//重新上DC初始化
 220   3                              gRTC_Hour   = gRTC_Hour_bk;
 221   3                              gRTC_Minute = gRTC_Minute_bk;
 222   3                              gRTC_Day    = gRTC_Day_bk;
 223   3                              gRTC_Month  = gRTC_Month_bk;
 224   3                              gRTC_Year   = gRTC_Year_bk;
 225   3                              gRTC_Zone   = gRTC_Zone_bk;
 226   3                      }
 227   2              }
 228   1      }
 229          
 230          
 231          
 232          
 233          
 234          
 235          
 236          
 237          
 238          
 239          
C51 COMPILER V9.00   SYS_SLEEP                                                             12/06/2018 14:18:36 PAGE 5   

 240          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    220    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      1    ----
   IDATA SIZE       =   ----       1
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
