C51 COMPILER V9.00   APP_MAIN                                                              12/04/2018 17:45:56 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE APP_MAIN
OBJECT MODULE PLACED IN ..\Object\app_main.obj
COMPILER INVOKED BY: D:\ProgramFiles\Keil_v5\C51\BIN\C51.EXE ..\Hardware\app_main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\U
                    -ser;..\Hardware;..\Hardware\BT;..\Hardware\KEY;..\Hardware\LED) DEBUG OBJECTEXTEND PRINT(.\Listings\app_main.lst) OBJECT
                    -(..\Object\app_main.obj)

line level    source

   1          /*************************************************************/
   2          /*头文件Header File*******************************************/
   3          /*************************************************************/
   4          #include "app_main.h"
   5          
   6          /*************************************************************/
   7          /*宏定义Macro Definition**************************************/
   8          /*************************************************************/
   9          
  10          /*************************************************************/
  11          /*类型定义Byte Definition**************************************/
  12          /*************************************************************/
  13          TIME_TEMP_ST_TypeDef  Time_Temp_TD;
  14          ALRAM_ST_TypeDef  AL1_TD;//闹钟相关
  15          
  16          /*************************************************************/
  17          /*标志位定义Flags Definition***********************************/
  18          /*************************************************************/
  19          bit    AppTick0;
  20          bit    AppTick1;
  21          bit    AppTick2;
  22          bit    AppTick3;
  23          bit    AppTick4;
  24          bit    AppTick5;
  25          bit    AppTick1ms;
  26          
  27          bit    Flag_12HourDisplay;
  28          bit    Flag_0_5s; //0.5s
  29          bit    Flag_LeapYear;//闰年标志，1为闰年，0为平年
  30          BOOL   gbPowerOn;//开关机状态，1为开机
  31          BOOL   gbDispleyFull;//显示满，1为满
  32          BOOL   SleepEnable;
  33          
  34          /*************************************************************/
  35          /*变量定义Variable Definition**********************************/
  36          /*************************************************************/
  37          uint8_t  idata cntAppTick;
  38          
  39          BOOL               gRTC_HalfSecond;
  40          uint8_t  idata gRTC_Sec;//RTC数据 
  41          uint8_t  idata gRTC_Sec_bk;
  42          uint8_t  idata gRTC_Minute;
  43          uint8_t  idata gRTC_Minute_bk;
  44          uint8_t  idata gRTC_Hour;
  45          uint8_t  idata gRTC_Hour_bk;
  46          uint8_t  idata gRTC_Hour_bk_24;//计数24小时
  47          uint8_t  idata gRTC_Day;
  48          uint8_t  idata gRTC_Day_bk;
  49          uint8_t  idata gRTC_Month;
  50          uint8_t  idata gRTC_Month_bk;
  51          uint8_t  idata gRTC_Year;
  52          uint8_t  idata gRTC_Year_bk;
  53          uint8_t  idata gRTC_Zone;
C51 COMPILER V9.00   APP_MAIN                                                              12/04/2018 17:45:56 PAGE 2   

  54          uint8_t  idata gRTC_Week; //一周7天
  55          uint8_t  idata cntNoFlash;
  56          uint8_t            gbDimmer;//亮度
  57          uint8_t  idata cnt0_5s;//计数到500ms就反转Flag_0_5s
  58          
  59          uint8_t  idata sys_Volume;
  60          
  61          
  62          /*************************************************************/
  63          /*数组定义Array Definition************************************/
  64          /*************************************************************/
  65          
  66          /*************************************************************/
  67          /*函数声明Function Declaration*********************************/
  68          /*************************************************************/
  69          
  70          /*************************************************************/
  71          /*函数定义Function Definition**********************************/
  72          /*************************************************************/
  73          /*******************************************************************************
  74          * 函数原型：
  75          * 输入参数：
  76          * 输出参数：
  77          * 函数功能：退出显示计数
  78          * 返回值说明：
  79          * 创建日期：
  80          * 创建人：
  81          * 修改日期
  82          * 修改人：
  83          * 第N次修改：
  84          * 修改原因：
  85          * 备注：
  86          *******************************************************************************/
  87          void DisplayStatusExit(void)
  88          {
  89   1              if (cntDisplayStatus)
  90   1              {
  91   2                      if (++cnt0_5s >= cDISP_DELAY_500ms)//10ms调用一次，计数到500ms就进入
  92   2                      {
  93   3                              cnt0_5s = 0;
  94   3                              Flag_0_5s = ~Flag_0_5s;
  95   3                      }
  96   2                      if (--cntDisplayStatus == 0)
  97   2                      {
  98   3                              switch (Flag_DisplayStatus)
  99   3                              {
 100   4                                      case DISP_CLK:
 101   4                                              break;
 102   4                                      default:
 103   4                                              cntDisplayStatus = cDISP_DELAY_60ms;
 104   4                                              Flag_DisplayStatus = DISP_CLK;
 105   4                                              break;
 106   4                              }
 107   3                      }
 108   2              }
 109   1      }
 110          
 111          /*******************************************************************************
 112          * 函数原型：
 113          * 输入参数：
 114          * 输出参数：
 115          * 函数功能：时间比较，每秒钟进来一次
C51 COMPILER V9.00   APP_MAIN                                                              12/04/2018 17:45:56 PAGE 3   

 116          * 返回值说明：
 117          * 创建日期：
 118          * 创建人：
 119          * 修改日期
 120          * 修改人：
 121          * 第N次修改：
 122          * 修改原因：
 123          * 备注：
 124          *******************************************************************************/
 125          void Compare_1MinutePorc(void)
 126          {
 127   1              //static uint8_t  cntSetVolume; //此变量只在上电时初始化一次，再调用此函数时不会执行此语句
 128   1              /*******************************************************************************
 129   1               *功能：
 130   1               *
 131   1               *这里是1s进来一次
 132   1               *******************************************************************************/
 133   1              if(gRTC_Sec!=gRTC_Sec_bk)
 134   1              {
 135   2                      gRTC_Sec_bk=gRTC_Sec;
 136   2                      
 137   2                      /*******************************************************************************
 138   2                       *功能：
 139   2                       *
 140   2                       *这里是1s进来一次
 141   2                       *******************************************************************************/
 142   2                      if(gRTC_Minute!=gRTC_Minute_bk)//分钟
 143   2                      {
 144   3                              gRTC_Minute_bk=gRTC_Minute;
 145   3                              
 146   3                              /*******************************************************************************
 147   3                               *功能：
 148   3                               *
 149   3                               *这里是1hour进来一次
 150   3                               *******************************************************************************/
 151   3                              if(gRTC_Hour!=gRTC_Hour_bk)//小时
 152   3                              {
 153   4                                      gRTC_Hour_bk=gRTC_Hour_bk;
 154   4                                      gRTC_Hour_bk_24++;
 155   4                                      if(gRTC_Hour_bk_24>=24)
 156   4                                      {
 157   5                                              gRTC_Hour_bk_24=0;
 158   5                                              
 159   5                                      }
 160   4                              }
 161   3                      }
 162   2              }
 163   1      }
 164          
 165          /*******************************************************************************
 166          * 函数原型：
 167          * 输入参数：
 168          * 输出参数：
 169          * 函数功能：滴答定时器计时函数
 170          * 返回值说明：
 171          * 创建日期：
 172          * 创建人：
 173          * 修改日期
 174          * 修改人：
 175          * 第N次修改：
 176          * 修改原因：
 177          * 备注：
C51 COMPILER V9.00   APP_MAIN                                                              12/04/2018 17:45:56 PAGE 4   

 178          *******************************************************************************/
 179          void Sys_Tick(void)
 180          {
 181   1              AppTick1ms=1;
 182   1              if(cntAppTick==0)
 183   1                      AppTick0=1;
 184   1              if(cntAppTick==1)
 185   1                      AppTick1=1;
 186   1              if(cntAppTick==2)
 187   1                      AppTick2=1;
 188   1              if(cntAppTick==3)
 189   1                      AppTick3=1;
 190   1              if(cntAppTick==4)
 191   1                      AppTick4=1;
 192   1              if(cntAppTick==5)
 193   1                      AppTick5=1;
 194   1              if(cntAppTick==6)
 195   1              {
 196   2                      if((--uart1_TX_Timeout)==0)//发送超时就清零发送标志位
 197   2                              uart1_EnableSend=0;
 198   2                      if((--uart1_RX_Timeout)==0)
 199   2                              uart1_RX_Pointer=0;
 200   2              }
 201   1              if(++cntAppTick>=10)
 202   1              {
 203   2                      cntAppTick=0;
 204   2              }
 205   1      }
 206          
 207          /*******************************************************************************
 208          * 函数原型：
 209          * 输入参数：
 210          * 输出参数：
 211          * 函数功能：初始化函数
 212          * 返回值说明：
 213          * 创建日期：
 214          * 创建人：
 215          * 修改日期
 216          * 修改人：
 217          * 第N次修改：
 218          * 修改原因：
 219          * 备注：
 220          *******************************************************************************/
 221          void PowerON_Init(void)
 222          {
 223   1              gRTC_Year=18;   //上电默认2018年
 224   1              gRTC_Month=11;  //上电默认11月
 225   1              gRTC_Day=0;             //上电默认为1号
 226   1              gRTC_Hour=0;    //上电默认为凌晨零点零分零秒
 227   1              gRTC_Minute=0;  //上电默认为
 228   1              gRTC_Sec=0;             //上电默认为
 229   1              gRTC_Hour_bk=0; //上电默认为凌晨零点零分零秒
 230   1              gRTC_Minute_bk=0;//上电默认为
 231   1              gRTC_Sec_bk=0;  //上电默认为
 232   1              Flag_LeapYear=0;//2018年不是闰年
 233   1              
 234   1              cntNoFlash = 0;
 235   1              cnt0_5s=0;
 236   1              gbPowerOn = 0;
 237   1              gbDimmer=3;
 238   1      }
 239          
C51 COMPILER V9.00   APP_MAIN                                                              12/04/2018 17:45:56 PAGE 5   

 240          /*******************************************************************************
 241          * 函数原型：
 242          * 输入参数：
 243          * 输出参数：
 244          * 函数功能：app_main函数
 245          * 返回值说明：
 246          * 创建日期：
 247          * 创建人：
 248          * 修改日期
 249          * 修改人：
 250          * 第N次修改：
 251          * 修改原因：
 252          * 备注：
 253          *******************************************************************************/
 254          void app_main(void)
 255          {
 256   1              PowerON_Init();
 257   1              while(1)
 258   1              {
 259   2                      if(AppTick1ms)
 260   2                      {
 261   3                              AppTick1ms=0;
 262   3                      }
 263   2                      if(AppTick0)
 264   2                      {
 265   3                              AppTick0=0;
 266   3                              KeyScan();
 267   3                              KeyComMsg();
 268   3                      }
 269   2                      if((AppTick1) || (AppTick2))
 270   2                      {
 271   3                              AppTick1=0;
 272   3                              AppTick2=0;
 273   3                              //BlueMode_Handle();
 274   3                              
 275   3                      }
 276   2                      if(AppTick3)
 277   2                      {
 278   3                              AppTick3=0;
 279   3                              Display();
 280   3                      }
 281   2                      if(AppTick4)
 282   2                      {
 283   3                              AppTick4=0;
 284   3                              DisplayStatusExit();
 285   3                      }
 286   2                      if(AppTick5)
 287   2                      {
 288   3                              AppTick5=0;
 289   3                              //Timing_Handle();
 290   3                              Compare_1MinutePorc();
 291   3                      }
 292   2              }
 293   1      }
 294          
 295          
 296          
 297          
 298          
 299          
 300          
 301          
C51 COMPILER V9.00   APP_MAIN                                                              12/04/2018 17:45:56 PAGE 6   

 302          
 303          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    267    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     17    ----
   IDATA SIZE       =     19    ----
   BIT SIZE         =     14    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
